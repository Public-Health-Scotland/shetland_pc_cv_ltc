---
title: "Shetland PCPIP Indicators"
author: "LIST (Local Intelligence Support Team) - Public Health Scotland"
date: "Updated: `r format(Sys.Date(), '%d %B %Y')`"
params:
  data_date: "June 2025"
output:
  html_document:
    css: phs_style.css
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', out.width = '100%')

# Copy in the PHS style CSS file if required
if (!file.exists(file.path(getwd(), "phs_style.css"))) {
  phstemplates::add_stylecss(getwd(), auto_open = FALSE, shinycss = FALSE)
}
```

```{r load_packages, include=FALSE}
library(crosstalk)
library(dplyr)
library(scales)
library(plotly)
library(DT)
library(phsstyles)
library(openxlsx)
```

```{r get_prev_data, include=FALSE}
source("prevalence.R")
```

```{r get_pharma_data, include=FALSE}
source("pharma.R")
```

```{r get_pharma_1_data, include=FALSE}
source("pharma1.R")
```

```{r source_functions}
source("functions/make_dt.R")
source("functions/create_subplot_title_annotations.R")
```

```{r join_indicator_data}
all_data <- monthly_summary |>
  left_join(
    pharmacist_reviews,
    by = join_by(census_date, PracticeID),
    relationship = "one-to-one"
  ) |>
  left_join(
    quarterly_event_type |> 
      pivot_wider(
        id_cols = c(PracticeID, quarter_start),
        names_from = DerivedEventType, 
        values_from = event_type_proportion, 
        values_fill = 0.0
        ),
    by = join_by(census_date == quarter_start, PracticeID),
    relationship = "one-to-one"
  ) |>
  left_join(
    pharma_1_monthly,
    by = join_by(census_date, PracticeID),
    relationship = "one-to-one"
  ) |>
  filter(census_date >= as.Date("2022-01-01")) |>
  mutate(
    census_date = as.Date(census_date),
    PracticeID = factor(PracticeID, levels = unique(PracticeID)),
    across(where(is.numeric), \(x) replace_na(x, 0))
    ) 

practice_ids <- unique(sort(all_data[["PracticeID"]]))
n_practices <- length(practice_ids)
```

```{r setup_crosstalk}
# Wrap the data frame in SharedData
# Use PracticeID as the key for linking
shared_monthly_summary <- SharedData$new(
  data = all_data,
  key = ~PracticeID,
  group = "practice_selection"
)
```

```{r make_plotly_palette}
phs_accessible_colours <- c(
  "#12436D", # Dark Blue
  "#28A197", # Turquoise
  "#801650", # Pink
  "#F46A25", # Orange
  "#3D3D3D", # Grey
  "#3E8ECC", # Light Blue
  "#3F085C", # Dark Purple
  "#94AABD", # Dark Blue Tint
  "#B4DEDB", # Turquoise Tint
  "#CCA2B9", # Pink Tint
  "#FBC3A8", # Orange Tint
  "#A8A8A8", # Grey Tint
  "#A8CCE8", # Light Blue Tint
  "#A285D1" # Light Purple
)


practice_colours <- setNames(
  object = phs_accessible_colours[seq_along(practice_ids)],
  nm = practice_ids
)

symbols_to_use <- c("circle", "cross", "star")
practice_symbols <- setNames(
  object = rep(symbols_to_use, length.out = n_practices),
  nm = practice_ids
)
```

# Shetland PCPIP Indicators

These indicators have been produced by LIST (the Local Intelligence Support Team), in collaboration with NHS Shetland. Patient-level data has been extracted from SHIP, and it was then anonymised before being sent securely to PHS.

The indicators are a Work In Progress; there may be issues with the indicator definition or with the analysis methodology. We will work to improve them, iterating on feedback received. Other apparent issues with the indicators may, in fact, be highlighting coding differences between (or even within) practices.

This report is based on data up to the end of `r params$data_date`.

## GP Practice selection

Select one or more GP Practices here; by default, all practices are shown, however, viewing 9 practices on a single plot will often look quite chaotic!

All plots and data tables will be filtered to the selected practice(s).

```{r interactive_filter}
# Function to dynamically determine the number of columns
best_n_cols <- function(x) {
  factors <- which(x %% 1L:(x - 1L) == 0L)
  closest_factor <- factors[which.min(abs(factors - sqrt(x)))]
  return(closest_factor)
}

# Create the filter control for GP practice
# Allows selecting one or more practices
filter_checkbox(
  id = "practice_filter",
  label = "Select GP Practice(s):",
  sharedData = shared_monthly_summary,
  group = ~PracticeID, # Filter based on the PracticeID column,
  columns = best_n_cols(n_practices)
)
```

## Long Term Conditions

For identifying patients with a long-term condition, we look for a relevant 'Record of Diagnosis' event and start counting them from that month onwards. We will stop counting a patient if they die, or if we have a record indicating that they have left Shetland, or that the condition has been resolved. We carry out this process Shetland-wide and assign patients to a practice based on their most recent data. This method is quite reliable, as it takes into account any 'Joined practice' events, and it remains effective even if some information hasn't been coded or updated.

When calculating the LTC review indicators we allow a '15-month grace period', which means that someone we don't include a patient in the monthly indicators until they have been diagnosed for at least 15 months.

This methodology is consistent with SHIP, but there a still small differences in the exact numbers and patients identified. We will continue to investigate this and improve where possible.


### Cardiovascular disease prevalence

This looks at the prevalence of patients identified as having Cardiovascular Disease per practice. This is relevant because these patients are used as the denominator in the calculation of the subsequent indicators.

```{r cv_prev_plotly}
cv_prev_plotly <- plot_ly(
  shared_monthly_summary,
  x = ~census_date,
  y = ~list_prev,
  color = ~PracticeID,
  symbol = ~PracticeID,
  colors = practice_colours,
  symbols = practice_symbols,
  type = "scatter",
  mode = "lines+markers",
  hoverinfo = "text",
  text = ~ paste(
    "Practice:", PracticeID,
    "<br>Month:", census_date,
    "<br>CV Prevalence:", percent(list_prev, accuracy = 0.1),
    "<br>List size:", list_pop,
    "<br>CV patients count:", ltc_prev_count
  )
) |>
  layout(
    title = str_wrap("Monthly CV Prevalence percentage by GP Practice", 25),
    xaxis = list(title = "Month"),
    yaxis = list(
      title = "CV Prevalence percentage",
      tickformat = ".1%"
    ),
    showlegend = TRUE,
    legend = list(
      title = list(text = "Practice ID")
    )
  )
```

```{r cv_prev_dt}
cv_prev_dt <- make_dt(
  shared_data = shared_monthly_summary,
  main_var = "list_prev",
  main_name = "CV prevalence percentage",
  percentage = TRUE
)
```

```{r display_cv_prev_elements}
# Display the plot and table
cv_prev_plotly
cv_prev_dt
```

### Cardiovascular disease review invites

This indicator is defined as '*% of patients with CV LTC who have been invited to a first LTC appointment in the past 15 months'*. Specifically:

NUMERATOR: Count of people with CV LTC who have been invited to a first appointment in the past 15 months.

DENOMINATOR: Count of people with CV LTCs.

```{r cv_ctac_1_plotly}
# It uses the shared data, so it will update based on the filter
cv_ctac_1_plotly <- plot_ly(
  shared_monthly_summary,
  x = ~census_date,
  y = ~ltc_invite_prop,
  color = ~PracticeID,
  symbol = ~PracticeID,
  colors = practice_colours,
  symbols = practice_symbols,
  type = "scatter",
  mode = "lines+markers",
  hoverinfo = "text",
  text = ~ paste("Practice:", PracticeID, "<br>Month:", census_date, "<br>Invite percentage:", percent(ltc_invite_prop, accuracy = 0.1))
) |>
  layout(
    title = str_wrap("Monthly CV invite percentage by GP practice", 25),
    xaxis = list(title = "Month"),
    yaxis = list(
      title = "Percentage",
      tickformat = ".1%"
    )
  )
```

```{r cv_ctac_1_dt}
cv_ctac_1_dt <- make_dt(
  shared_data = shared_monthly_summary,
  main_var = "ltc_invite_prop",
  main_name = "Invite Percentage",
  percentage = TRUE
)
```

```{r display_cv_ctac_1_elements}
# Display the plot and table
cv_ctac_1_plotly
cv_ctac_1_dt
```

### Cardiovascular disease review attendances

This indicator is defined as *'% of patients with CV LTC who have attended a first LTC appointment in the past 15 months'*. Specifically:

NUMERATOR: Count of people with CV LTC who have attended a first appointment in the past 15 months.

DENOMINATOR: Count of people with CV LTCs.

```{r cv_ctac_2_plotly}
# It uses the shared data, so it will update based on the filter
cv_ctac_2_plotly <- plot_ly(
  shared_monthly_summary,
  x = ~census_date,
  y = ~ltc_attend_prop,
  color = ~PracticeID,
  symbol = ~PracticeID,
  colors = practice_colours,
  symbols = practice_symbols,
  type = "scatter",
  mode = "lines+markers",
  hoverinfo = "text",
  text = ~ paste("Practice:", PracticeID, "<br>Month:", census_date, "<br>Attend percentage:", percent(ltc_attend_prop, accuracy = 0.1))
) |>
  layout(
    title = str_wrap("Monthly CV attend percentage by GP practice", 25),
    xaxis = list(title = "Month"),
    yaxis = list(
      title = "Percentage",
      tickformat = ".1%"
    )
  )
```

```{r cv_ctac_2_dt}
# Create the DT datatable
cv_ctac_2_dt <- make_dt(
  shared_data = shared_monthly_summary,
  main_var = "ltc_attend_prop",
  main_name = "Attend percentage",
  percentage = TRUE
)
```

```{r display_cv_ctac_2_elements}
# Display the plot and table
cv_ctac_2_plotly
cv_ctac_2_dt
```

### Cardiovascular disease first appointment attendances

This indicator is defined as *'% of people with a CV LTC who attended their first appointment within 60 days of being invited'*. Specifically:

NUMERATOR: Count of people with LTCs who have attended an appointment within 60 days of the invite.

DENOMINATOR: Count of people with CV LTC who have been invited to a first appointment this month.

Note that this indicator does not use the 15-month 'grace period' from diagnosis, as it is based on patients being sent an invite within the given month. 

```{r cv_ctac_3_plotly}
# It uses the shared data, so it will update based on the filter
cv_ctac_3_plotly <- plot_ly(
  shared_monthly_summary,
  x = ~census_date,
  y = ~ltc_first_invite_attend_prop,
  color = ~PracticeID,
  symbol = ~PracticeID,
  colors = practice_colours,
  symbols = practice_symbols,
  type = "scatter",
  mode = "lines+markers",
  hoverinfo = "text",
  connectgaps = TRUE,
  text = ~ paste(
    "Practice:", PracticeID,
    "<br>Month:", census_date,
    "<br>Invites sent:", ltc_first_invite_count,
    "<br>Attend percentage:", percent(ltc_first_invite_attend_prop, accuracy = 0.1))
) |>
  layout(
    title = str_wrap("Monthly CV attendances within 60 days of first invite", 25),
    xaxis = list(title = "Month"),
    yaxis = list(
      title = "Percentage",
      tickformat = ".1%"
    )
  )
```

```{r cv_ctac_3_dt}
# Create the DT datatable
cv_ctac_3_dt <- make_dt(
  shared_data = shared_monthly_summary,
  var = "ltc_first_invite_attend_prop",
  name = "Attend percentage",
  percentage = TRUE
)
```

```{r display_cv_ctac_3_elements}
# Display the plot and table
cv_ctac_3_plotly
cv_ctac_3_dt
```

### Cardiovascular disease House of Care letter after first attendance

This indicator is defined as *'% of people with a CV LTC who attended a first  appointment who have a House of Care letter sent out to them'*. Specifically:

NUMERATOR: Count of people with CV LTC who attended first appointment who have had House of Care letter sent out within 30 days after attendance (41C1)

DENOMINATOR: Number of people with LTCs attending a first appointment in last 15 months.

Note that this indicator does not use the 15-month 'grace period' from diagnosis, as it is based on patients attending an appointment. 

```{r cv_ctac_4_plotly}
# It uses the shared data, so it will update based on the filter
cv_ctac_4_plotly <- plot_ly(
  shared_monthly_summary,
  x = ~census_date,
  y = ~ltc_first_attend_hoc_sent_prop,
  color = ~PracticeID,
  symbol = ~PracticeID,
  colors = practice_colours,
  symbols = practice_symbols,
  type = "scatter",
  mode = "lines+markers",
  hoverinfo = "text",
  connectgaps = TRUE,
  text = ~ paste(
    "Practice:", PracticeID,
    "<br>Month:", census_date,
    "<br>First attendances (in the last 15 months):", ltc_first_attend_count,
    "<br>HoC sent percentage:", percent(ltc_first_attend_hoc_sent_prop, accuracy = 0.1))
) |>
  layout(
    title = str_wrap("Monthly HoC letters sent within 30 days of first attendance (last 15 months of attendances)", 25),
    xaxis = list(title = "Month"),
    yaxis = list(
      title = "Percentage",
      tickformat = ".1%"
    )
  )
```

```{r cv_ctac_4_dt}
# Create the DT datatable
cv_ctac_4_dt <- make_dt(
  shared_data = shared_monthly_summary,
  main_var = "ltc_first_attend_hoc_sent_prop",
  main_name = "HoC sent percentage",
  other_vars = "ltc_first_attend_count",
  other_names = "First attendances - last 15m",
  percentage = TRUE
)
```

```{r display_cv_ctac_4_elements}
# Display the plot and table
cv_ctac_4_plotly
cv_ctac_4_dt
```

## Pharmacotherapy

### Reviews by a pharmacist

This indicator is defined as *'% of medication reviews completed by a Pharmacist'*. Specifically:

NUMERATOR: Count of medication reviews conducted by Pharmacist

DENOMINATOR: Count of medication reviews completed

```{r pharm_6_plotly}
# It uses the shared data, so it will update based on the filter
pharm_6_plotly <- plot_ly(
  shared_monthly_summary,
  x = ~census_date,
  y = ~pharmacist_proportion,
  color = ~PracticeID,
  symbol = ~PracticeID,
  colors = practice_colours,
  symbols = practice_symbols,
  type = "scatter",
  mode = "lines+markers",
  hoverinfo = "text",
  text = ~ paste("Practice:", PracticeID, "<br>Month:", census_date, "<br>Percentage by pharmacist:", percent(pharmacist_proportion, accuracy = 0.1))
) |>
  layout(
    title = str_wrap("Monthly percentage of reviews completed by a pharmacist", 25),
    xaxis = list(title = "Month"),
    yaxis = list(
      title = "Percentage",
      tickformat = ".1%"
    )
  )
```

```{r pharm_6_dt}
# Create the DT datatable
pharm_6_dt <- make_dt(
  shared_data = shared_monthly_summary,
  main_var = "pharmacist_proportion",
  main_name = "Percentage by pharmacist",
  percentage = TRUE
)
```

```{r display_pharm_6_elements}
pharm_6_plotly
pharm_6_dt
```

### Types of medication review conducted

This indicator looks at the type of medication review conducted, it is presented quarterly as a percentage of all reviews. It is possible to present this indicator monthly but the data tends to be very 'noisy'. The types of review are:

1.  Medication Review with Person
2.  Notes-based Medication Review
3.  Polypharmacy Medication Review

Note that this plot will not be affected by the practice filter.

```{r pharm_9_plotly}
subplot_margin_value <- 0.03
nrows <- 3

subplot_title_annotations <- create_subplot_title_annotations(
  num_rows = nrows, # Pass the number of rows for your subplot grid
  titles_vector = practice_ids, # Pass the vector of unique practice IDs
  subplot_margin = subplot_margin_value
)

event_type_colours <- setNames(
  object = c("#12436D", "#28A197", "#801650"), 
  nm =  unique(pull(quarterly_event_type, DerivedEventType))
  )

pharm_9_plotly <- quarterly_event_type |>
  group_by(PracticeID) %>%
  group_map(
    \(practice_data, practice_id) {
      practice_id_label <- paste("Practice ", practice_id)

      first_practice_id <- practice_ids[1]
      is_first_practice <- as.integer(practice_id) == first_practice_id

      plot_ly(
        data = practice_data,
        x = ~quarter_start,
        y = ~event_type_proportion,
        color = ~DerivedEventType,
        colors = event_type_colours,
        symbol = ~PracticeID,
        symbols = practice_symbols,
        marker = list(size = 8),
        line = list(size = 2),
        type = "scatter",
        mode = "lines+markers",
        hoverinfo = "text",
        text = ~ paste(
          "Quarter start:", quarter_start,
          "<br>Event type:", DerivedEventType,
          "<br>Percentage:", round(event_type_proportion * 100, 1), "%"
        ),
        legendgroup = ~DerivedEventType,
        name = ~DerivedEventType,
        showlegend = is_first_practice
      ) |>
        layout(
          title = list(text = practice_id_label, font = list(size = 12)),
          hovermode = "x",
          showlegend = FALSE,
          # Set titles to empty strings to prevent them from showing on individual subplots.
          # The shared titles will be applied by the main layout.
          xaxis = list(title = ""),
          yaxis = list(title = "")
        )
    },
    .keep = TRUE
  ) |>
  subplot(
    nrows = 4,
    shareX = TRUE,
    shareY = TRUE,
    margin = subplot_margin_value
  ) |>
  layout(
    # Overall plot title
    title = list(text = str_wrap("<b>Quarterly Type of Review by Practice</b>", 25)),
    showlegend = TRUE,
    legend = list(
      title = list(text = "Review Type"),
      orientation = "h", # Place legend horizontally.
      x = 0.5, y = 0.1, # Position legend below the plot area.
      xanchor = "center"
    ),
    annotations = c(
      list(
        # X-axis label
        list(
          x = 0.5, # Centre horizontally
          y = 0.1, # Position below the plots (adjust as needed)
          text = "<b>Quarter</b>",
          showarrow = FALSE,
          xref = "paper",
          yref = "paper",
          xanchor = "center",
          yanchor = "bottom"
        ),
        # Y-axis label
        list(
          x = -0.04, # Position to the left of the plots (adjust as needed)
          y = 0.6, # Centre vertically
          text = "<b>Review Type Percentage</b>",
          showarrow = FALSE,
          xref = "paper",
          yref = "paper",
          xanchor = "right",
          yanchor = "middle",
          textangle = -90 # Rotate text for vertical label
        )
      ),
      subplot_title_annotations
    )
  )
```

Note that in this iteration, the below data table includes blank rows for months that are not the start of the quarter.

```{r pharm_9_dt}
# Create the DT datatable
pharm_9_dt <- make_dt(
  shared_data = shared_monthly_summary,
  main_var = c("Medication Review with Person",  "Notes based Medication Review", "Polypharmacy Medication Review"),
  keep_cols = "DerivedEventType",
  percentage = TRUE
)
```

```{r display_pharm_9_elements}
pharm_9_plotly
pharm_9_dt
```

### Completed Medication Reviews (90 days)

This indicator is defined as *% of people on regular medication who have had a medication review completed within 90 days of birth month*. Specifically:

NUMERATOR: Number of people coded as having a medication review completed within 90 days of birth month

DENOMINATOR: Total number of people who have been issued a repeat prescription in the previous 12 months

```{r pharma1_90_plotly}
# It uses the shared data, so it will update based on the filter
pharma1_90_plotly <- plot_ly(
  shared_monthly_summary,
  x = ~census_date,
  y = ~prop_review_90,
  color = ~PracticeID,
  symbol = ~PracticeID,
  colors = practice_colours,
  symbols = practice_symbols,
  type = "scatter",
  mode = "lines+markers",
  hoverinfo = "text",
  text = ~ paste("Practice:", PracticeID, "<br>Month:", census_date, "<br>Proportion Reviewed (90 days):", percent(prop_review_90, accuracy = 0.1))
) |>
  layout(
    title = str_wrap("Proportion Reviewed (90 days)", 25),
    xaxis = list(title = "Month"),
    yaxis = list(
      title = "Percentage",
      tickformat = ".1%"
    )
  )
```

```{r pharma1_90_dt}
pharma1_90_dt <- make_dt(
  shared_data = shared_monthly_summary,
  main_var = "prop_review_90",
  main_name = "Proportion Reviewed (90 days)",
  percentage = TRUE
)
```

```{r display_pharma1_90}
# Display the plot and table
pharma1_90_plotly
pharma1_90_dt
```

### Completed Medication Reviews (180 days)

This indicator is defined as *% of people on regular medication who have had a medication review completed within 180 days of birth month*. Specifically:

NUMERATOR: Number of people coded as having a medication review completed within 180 days of birth month

DENOMINATOR: Total number of people who have been issued a repeat prescription in the previous 12 months

```{r pharma1__180plotly}
# It uses the shared data, so it will update based on the filter
pharma1_180_plotly <- plot_ly(
  shared_monthly_summary,
  x = ~census_date,
  y = ~review_180_prop,
  color = ~PracticeID,
  symbol = ~PracticeID,
  colors = practice_colours,
  symbols = practice_symbols,
  type = "scatter",
  mode = "lines+markers",
  hoverinfo = "text",
  text = ~ paste("Practice:", PracticeID, "<br>Month:", census_date, "<br>Proportion Reviewed (180 days):", percent(review_180_prop, accuracy = 0.1))
) |>
  layout(
    title = str_wrap("Proportion Reviewed (180 days)", 25),
    xaxis = list(title = "Month"),
    yaxis = list(
      title = "Percentage",
      tickformat = ".1%"
    )
  )
```

```{r pharma1_180_dt}
pharma1_180_dt <- make_dt(
  shared_data = shared_monthly_summary,
  main_var = "review_180_prop",
  main_name = "Proportion Reviewed (180 days)",
  percentage = TRUE
)
```

```{r display_pharma1_180}
# Display the plot and table
pharma1_180_plotly
pharma1_180_dt
```

```{r export-all-data-frames, message=FALSE, warning=FALSE}
# Create the named list of data frames and their sheet names
all_data_frames <- list(
  monthly_event_type = monthly_event_type,
  monthly_summary = monthly_summary,
  pharma_1_monthly = pharma_1_monthly,
  pharmacist_reviews = pharmacist_reviews,
  quarterly_event_type = quarterly_event_type
)

# Create a new workbook
wb <- createWorkbook()

# Add each data frame as a sheet and set column widths to auto
for (sheet_name in names(all_data_frames)) {
  addWorksheet(wb, sheet_name)
  writeData(wb, sheet_name, all_data_frames[[sheet_name]])
  setColWidths(wb, sheet = sheet_name, cols = 1:ncol(all_data_frames[[sheet_name]]), widths = "auto")
}

# Save the workbook to the specified path
file_path <- paste0("/conf/LIST_analytics/Shetland/Primary Care/LTC/data/outputs/Indicators_", params$data_date, ".xlsx")
saveWorkbook(wb, file_path, overwrite = TRUE)
